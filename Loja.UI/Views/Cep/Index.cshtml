@*
    For more information on enabling MVC for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860
*@
@model Loja.UI.Models.Cep.CepViewModel




<div class="row col s12" id="container_cep">
    @if (Model != null)
        @Model.ListaCep[0].Endereco
    <div class="input-field col s2">
        @* ao sair do campo chamar o metodo cep/buscarCep/ *@
        <input name="EndEtg_cep" type="text" id="cepEntrega" onblur="buscarCep()" />
        <label for="cepEntrega" id="lblcep">CEP</label>
    </div>
    <div class="input-field col s2">
        <button class="waves-effect waves-light btn-small"
                onclick="NaoseiCep()"
                type="button"
                style="margin-top:-1rem;">
            <i class="material-icons left">search</i>Não sei o CEP
        </button>
    </div>
    <div class="input-field col s4">
        <input name="EndEtg_endereco" id="enderecoEntrega" type="text" />
        <label id="lblEnderecoEntrega" for="endEntrega">ENDEREÇO </label>
    </div>
    <div class="input-field col s2">
        <input name="EndEtg_endereco_numero" id="numEntrega" type="text" />
        <label id="lblNumeroEntrega" for="numEntrega">NÚMERO </label>
    </div>
    <div class="input-field col s2">
        <input name="EndEtg_endereco_complemento" id="compEntrega" type="text" />
        <label id="lblComplementoEntrega" for="compEntrega">COMPLEMENTO</label>
    </div>
</div>
<div class="row col s12">
    <div class="input-field col s3">
        <input name="EndEtg_bairro" id="bairroEntrega" type="text" />
        <label id="lblBairroEntrega" for="bairroEntrega">BAIRRO</label>
    </div>
    <div class="input-field col s3">
        <input name="EndEtg_cidade" id="cidadeEntrega" type="text" />
        <label id="lblCidadeEntrega" for="cidadeEntrega">CIDADE</label>
    </div>
    <div class="input-field col s3">
        <input name="EndEtg_uf" id="ufEntrega" type="text" />
        <label id="lblUfEntrega" for="ufEntrega">UF</label>
    </div>
</div>

<div id="naoseicep" class="modal">
    <div class="modal-content">
        <section>
            <header style="margin-left: -10px;" class="row">
                Busca Cep
            </header>
            <article class="fixo">
                <div class="row col s12">
                    <div class="input-field col s2">
                        <select id="lstufs" name="lstufs" onclick="buscarUfs();" style="position:fixed;">
                            <option value="">Selecione</option>
                        </select>
                        <label>UF</label>
                    </div>
                    <div class="input-field col s4">
                        @*<input type="text" class="autocomplete" />*@
                        <input type="text" name="localidade" id="localidade" class="autocomplete" />
                        <label id="lblLocalidade" for="localidade">Localidade</label>
                    </div>
                    <div class="input-field col s4">
                        <input id="nendereco" name="nendereco" type="text" />
                        <label id="nlblendereco" for="nendereco">Endereço</label>
                    </div>
                    <div class="input-field col s2">
                        <button class="waves-effect waves-light btn-small"
                                type="button"
                                style="margin-top:2%;"
                                id="btnBuscar">
                            <i class="material-icons left">search</i>Buscar
                        </button>
                    </div>
                </div>
                <div style="max-height:80% !important">
                    <div class="row col s12 center" id="msg" style="display:none;"></div>
                    <table class="bordered striped centered highlight responsive-table tabela_endereco"
                           style="max-height:50%; display:none">
                        <thead>
                            <tr>
                                <th align="left" valign="bottom">

                                </th>
                                <th align="left" valign="bottom">
                                    CEP
                                </th>
                                <th align="left" valign="bottom">
                                    UF
                                </th>
                                <th align="left" valign="bottom">
                                    Cidade
                                </th>
                                <th align="left" valign="bottom">
                                    Bairro
                                </th>
                                <th align="left" valign="bottom">
                                    Lougradouro
                                </th>
                                <th align="left" valign="bottom">
                                    Complemento
                                </th>
                            </tr>
                        </thead>
                        <tbody class="destaquelinha" id="tableBody">
                        </tbody>
                    </table>
                </div>
            </article>
            <div class="modal-footer col s12" id="footer">
                <div class="container">
                    <button type="button" href="#!" class="modal-close waves-effect waves-green btn">Cancelar</button>
                    <button type="button" id="btnModificar" href="#!" class="modal-close waves-effect waves-green btn">
                        Modificar
                    </button>
                </div>
            </div>
        </section>
    </div>
</div>

<script>


    $("#btnModificar").click(function () {
        $('.teste').children().find('input').filter(function () {
            if ($(this).prop('checked') == true) {
                var elem = $(this).parent().parent().parent();
                inscreve(elem[0].children);
            }
        });
    });

    function montaTabela(data) {
        var cols = "";
        debugger;
        var lst = data["ListaCep"];

        if (lst.length > 0) {
            if ($('#msg').css("display", "block")) $('#msg').css("display", "none");
            $('.tabela_endereco').css("display", "block");
            for (var i = 0; i < lst.length; i++) {
                cols += "<tr id='linha' class='teste'>";
                cols += "<td>";
                cols += "<label><input class='with-gap check' type='radio' value='" + i + "'></input><span></span></label>";
                cols += "</td>";
                cols += "<td>" + lst[i].Cep + "</td>";
                cols += "<td>" + lst[i].Uf + "</td>";
                cols += "<td>" + lst[i].Cidade + "</td>";
                cols += "<td>" + lst[i].Bairro + "</td>";
                cols += "<td>" + lst[i].Endereco + "</td>";
                cols += "<td>" + lst[i].LogradouroComplemento + "</td></tr>";
                $("#tableBody").empty().append(cols);
            }

            $(".teste").click(function () {

                $(this).find('td').each(function (i) {
                    if ($(this).find('label')) {
                        $(this).find('label').each(function (s) {
                            if ($(this).find('input')) {
                                $(this).find('input').each(function (p) {
                                    var cbs = document.getElementsByClassName("check");
                                    for (var i = 0; i < cbs.length; i++) {
                                        if (cbs[i] !== $(this)) cbs[i].checked = false;
                                    }
                                    $(this).prop('checked', true);
                                })
                            }
                        })
                    }
                });
            });
        }
        else {
            if ($('.tabela_endereco').css("display", "block")) $('.tabela_endereco').css("display", "none");
            var msg = "<span> Endereço não encontrado!</span>";
            $("#msg").css("display", "block");
            $("#msg").empty().append(msg);
        }


    }

    function limparCamposEndEntrega() {
        $('#cepEntrega').val('');
        $('#ufEntrega').val('');
        $('#cidadeEntrega').val('');
        $('#bairroEntrega').val('');
        $('#enderecoEntrega').val('');
        $('#compEntrega').val('');
        $('#numEntrega').val('');
    }

    

    $('#btnBuscar').on('click', function () {
        $.ajax({
            url: "../Cep/BuscarCepPorEndereco/",
            type: "GET",
            data: { nendereco: $('#nendereco').val(), localidade: $('#localidade').val(), lstufs: $('#lstufs').val() },
            dataType: "json",
            success: function (t) {
                montaTabela(t);
            }
        });
    })

    $("#lstufs").on('change', function (e) {
        if ($('#localidade').val() != "") {
            $('#localidade').val("");
        }
        if ($('#nendereco').val() != "") {
            $('#nendereco').val("");
        }

        $.ajax({
            url: "../Cep/BuscarLocalidades/",
            type: "GET",
            data: { uf: $(this).val() },
            dataType: "json",
            success: function (t) {
                var city = {};
                $.each(t, function (i, d) {
                    city[d] = null;
                });
                $('input.autocomplete').autocomplete({
                    data: city,
                });
            }
        });
    });

    $("#lstufs").ready(function () {
        $.ajax({
            url: "../Cep/BuscarUfs/",
            type: "GET",
            dataType: "json",
            success: function (data) {
                var select = $('#lstufs');
                $.each(data, function (i, d) {
                    select.append("<option value='" + d + "'>" + d + "</option>");
                    select.formSelect();
                });
            }
        });
    });

    function NaoseiCep() {
        let Modalelem = document.getElementById('naoseicep');
        let instanceModal = M.Modal.init(Modalelem);
        instanceModal.open();
    };

    function buscarCep() {
    if ($('#cepEntrega').val() != null) {
        $('#naoseicep').addClass('pulse');

        debugger;
        $.ajax({
            url: "../Cep/BuscarCep/",
            type: "GET",
            data: { cep: $('#cepEntrega').val() },
            dataType: "json",
            success: function (data) {
                debugger;
                if (data[0].Endereco != "") {
                    $('#enderecoEntrega').prop("readonly", true);
                    $("#enderecoEntrega").val(data[0].Endereco);
                    $("#lblEnderecoEntrega").addClass('active');
                }
                else {
                    $('#enderecoEntrega').prop("readonly", false);
                }

                if (data[0].Bairro != "") {
                    $("#bairroEntrega").prop("readonly", true);
                    $("#bairroEntrega").val(data[0].Bairro);
                    $("#lblBairroEntrega").addClass('active');
                }
                else {
                    $("#bairroEntrega").prop("readonly", false);
                }

                if (data[0].Cidade != "") {
                    $("#cidadeEntrega").prop("readonly", true);
                    $("#cidadeEntrega").val(data[0].Cidade);
                    $("#lblCidadeEntrega").addClass('active');
                }
                else {
                    $("#cidadeEntrega").prop("readonly", false);
                }

                if (data[0].Uf != "") {
                    $("#ufEntrega").prop("readonly", true);
                    $("#ufEntrega").val(data[0].Uf);
                    $("#lblUfEntrega").addClass('active');
                }
                else {
                    $("#ufEntrega").prop("readonly", false);
                }

                if (data[0].logradouroComplemento != "" &&
                    data[0].logradouroComplemento != 'undefined' &&
                    data[0].logradouroComplemento != null) {
                    console.log(data[0].LogradouroComplemento);
                    $('#compEntrega').val(data[0].LogradouroComplemento);
                    $('#lblComplementoEntrega').addClass('active');
                }

                $('#naoseicep').removeClass('pulse');
            },
            error: function(data) {
                console.log(data);
            }
        })
    }
}


</script>
@*<script>
    requirejs(["Views/Cep/Index"], function (util) {
    });
</script>*@

<style>

    .dropdown-content {
        max-height: 400px;
        border-radius: 1em;
    }

    tbody {
        display: block;
        height: auto;
        max-height: 300px;
        overflow: auto;
    }

        thead, tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

    thead {
        width: calc( 100% - 1em )
    }

    table {
        width: 100%;
    }

    #footer {
        text-align: center;
        padding: 1em;
        flex-grow: 0;
        flex-shrink: 0;
    }

    .fixo {
        display: flex;
        flex-direction: column;
        height: 25%;
        min-height: 20vh;
    }

    .destaquelinha :hover {
        background-color: #d1d1d1 !important;
    }

    #naoseicep {
        width: 70% !important;
    }

    .dropdown-content select-dropdown {
        position: fixed;
    }

    .tabela_endereco {
        border: 1px solid #ccc;
        border-collapse: collapse;
        margin: 0;
        padding: 0;
        width: 100%;
        table-layout: fixed;
    }

        .tabela_endereco caption {
            font-size: 1.5em;
            margin: 0.5em 0 0.75em;
        }

        .tabela_endereco tr {
            background-color: #fbfbfb;
            border: 1px solid #ddd;
            padding: 0.35em;
        }

        .tabela_endereco th,
        .tabela_endereco td {
            padding: 0.625em;
            padding-left: 0.4em;
            padding-right: 0.4em;
            /*//text-align: center;*/
        }

        .tabela_endereco tbody td {
            white-space: initial;
            line-height: initial;
        }

        .tabela_endereco th {
            font-size: 0.85em;
            letter-spacing: 0.1em;
        }

    /*.tabela_endereco .mat-form-field {
            padding: 0em;
            padding-left: 0.4em;
            padding-right: 0.4em;
        }*/

    .modal {
        max-height: 80% !important;
        overflow-y: inherit !important;
        border-radius: 4px !important;
    }
</style>
